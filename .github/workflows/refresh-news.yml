name: Trigger News Refresh

on:
  schedule:
    # Every Monday at 8am UTC (3am EST)
    - cron: "0 8 * * 1"
  workflow_dispatch:
    inputs:
      priority:
        description: "Priority level to refresh (P0, P1, all)"
        required: false
        default: "P0"

permissions:
  issues: write

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Create refresh trigger issue
        uses: actions/github-script@v7
        with:
          script: |
            const priority = context.payload.inputs?.priority || 'P0';
            const trigger = context.eventName === 'schedule' ? 'weekly-cron' : 'manual';

            // Check if there's already an open refresh issue
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'refresh-news',
              state: 'open'
            });

            if (existing.data.length > 0) {
              console.log(`Skipping — open refresh issue already exists: #${existing.data[0].number}`);
              return;
            }

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[refresh-news] ${priority} — ${new Date().toISOString().split('T')[0]}`,
              body: [
                `## News Refresh Request`,
                ``,
                `- **Priority:** ${priority}`,
                `- **Trigger:** ${trigger}`,
                `- **Date:** ${new Date().toISOString()}`,
                ``,
                `This issue will be picked up by the Claude Code poller running locally.`,
                `It will be closed automatically when the refresh is complete.`
              ].join('\n'),
              labels: ['refresh-news']
            });

            console.log(`Created refresh issue #${issue.data.number}`);
